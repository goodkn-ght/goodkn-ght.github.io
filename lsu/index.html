<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MikeTheTiger.AI | LSU Knowledge Widget</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    :root {
      --accent-lsu: #582c83;
      --accent-gold: #fdd023;
      --accent-river: #6e7bff;
    }
    body { background: #04050c; }
    .container { max-width: 1150px; margin: 2rem auto 4rem; padding: 0 1.25rem; display: flex; flex-direction: column; gap: 1.5rem; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; }
    .hero-panel { padding: 2.5rem 1.75rem; border: 1px solid rgba(253,208,35,0.3); background: radial-gradient(circle at top, rgba(253,208,35,0.25), rgba(4,5,12,0.95)); border-radius: 24px; }
    .hero-panel--split { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 2rem; align-items: stretch; }
    .hero-copy h1 { margin: 0 0 0.5rem; font-size: clamp(2rem, 5vw, 3.1rem); }
    .hero-copy p { margin: 0.5rem 0; max-width: 620px; }
    .hero-list { list-style: none; margin: 1rem 0 0; padding: 0; display: grid; gap: 0.4rem; }
    .hero-list li { display: flex; gap: 0.4rem; align-items: center; color: rgba(255,255,255,0.85); }
    .hero-card { background: rgba(4,5,12,0.7); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 1.5rem; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }
    .hero-card pre { background: rgba(0,0,0,0.6); padding: 1rem; border-radius: 12px; overflow-x: auto; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.08); }
    .cta-row { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }
    .cta-primary, .cta-ghost { border-radius: 999px; padding: 0.8rem 1.4rem; font-weight: 600; text-decoration: none; }
    .cta-primary { background: linear-gradient(135deg, var(--accent-gold), #ffb347); color: #1a1100; }
    .cta-ghost { border: 1px solid rgba(255,255,255,0.35); color: var(--fg); }
    .hero-meta { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; color: var(--muted); font-size: 0.9rem; }
    .stat-deck { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin: 1.5rem 0 0; }
    .stat-card { border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 1rem; background: rgba(0,0,0,0.2); }
    .stat-card span { text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.75rem; color: var(--muted); }
    .stat-card strong { display: block; font-size: 1.8rem; margin: 0.35rem 0; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap: 1rem; }
    .meta-card { background: rgba(88,44,131,0.25); border: 1px solid rgba(88,44,131,0.4); border-radius: 14px; padding: 1rem; backdrop-filter: blur(4px); }
    .meta-card strong { display: block; font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.35rem; }
    .search-panel { display: flex; flex-direction: column; gap: 0.9rem; }
    .ask-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .ask-row input { flex: 1; min-width: 220px; background: #080a16; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; color: #fff; padding: 0.95rem 1rem; font-size: 1rem; }
    .ask-row button { background: linear-gradient(135deg, var(--accent-gold), #ffb347); border: none; padding: 0 1.9rem; border-radius: 12px; color: #2b1d00; font-weight: 700; letter-spacing: 0.03em; cursor: pointer; transition: transform 0.12s ease, box-shadow 0.2s; }
    .ask-row button:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(253,208,35,0.35); }
    .chip-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .chip { border: 1px solid rgba(253,208,35,0.4); color: var(--fg); padding: 0.45rem 1rem; border-radius: 999px; font-size: 0.85rem; cursor: pointer; background: rgba(253,208,35,0.12); }
    .chip:hover { border-color: var(--accent-gold); background: rgba(253,208,35,0.2); }
    .search-status { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .status-pill { display: inline-flex; align-items: center; gap: 0.35rem; border-radius: 999px; padding: 0.3rem 0.9rem; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.15); color: var(--muted); }
    .status-pill::before { content: ''; width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.35); }
    .status-pill.live { color: var(--fg); border-color: rgba(57,255,182,0.4); }
    .status-pill.live::before { background: #39ffb6; box-shadow: 0 0 8px rgba(57,255,182,0.6); }
    .results-panel { display: flex; flex-direction: column; gap: 1rem; }
    .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap: 1rem; }
    .result-card { border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 1.25rem; background: rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 0.9rem; min-height: 280px; }
    .result-card h3 { margin: 0; font-size: 1.15rem; }
    .fact-answer p { margin: 0.35rem 0; line-height: 1.65; }
    .reference-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 0.6rem; }
    .reference-card { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 0.8rem; background: rgba(255,255,255,0.03); }
    .reference-card h4 { margin: 0 0 0.25rem; font-size: 0.95rem; color: var(--fg); }
    .reference-card p { margin: 0; font-size: 0.85rem; color: var(--muted); }
    .tag-pill { display: inline-flex; align-items: center; gap: 0.2rem; border: 1px solid rgba(255,255,255,0.13); border-radius: 999px; padding: 0.18rem 0.6rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
    .web-results { display: flex; flex-direction: column; gap: 0.75rem; }
    .web-result { border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 0.95rem; background: rgba(255,255,255,0.02); display: flex; flex-direction: column; gap: 0.45rem; }
    .web-meta { font-size: 0.8rem; color: var(--muted); display: flex; gap: 0.5rem; flex-wrap: wrap; text-transform: uppercase; letter-spacing: 0.05em; }
    .web-result h4 { margin: 0; font-size: 1rem; }
    .web-result a { color: var(--accent-gold); text-decoration: none; }
    .web-result p { margin: 0; color: var(--muted); }
    .facts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 1rem; }
    .fact-card { border: 1px solid rgba(255,255,255,0.09); border-radius: 12px; padding: 1rem; background: rgba(255,255,255,0.03); }
    .fact-card span { display: block; font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.35rem; }
    .fact-card strong { font-size: 1.2rem; color: var(--fg); }
    .events-panel { display: flex; flex-direction: column; gap: 0.85rem; }
    .event-row { display: flex; gap: 0.9rem; align-items: flex-start; border-left: 3px solid var(--accent-gold); padding-left: 1rem; }
    .event-date { font-weight: 700; color: var(--accent-gold); min-width: 95px; font-variant-numeric: tabular-nums; }
    .event-row p { margin: 0.05rem 0 0; color: var(--muted); }
    .source-line { font-size: 0.8rem; color: var(--muted); margin-top: 0.4rem; }
    .live-panel { display: flex; flex-direction: column; gap: 0.9rem; }
    .live-header { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 0.8rem; align-items: flex-start; }
    .live-header h3 { margin: 0; font-size: 1.2rem; }
    .live-header p { margin: 0; color: var(--muted); font-size: 0.9rem; }
    .live-status { font-size: 0.85rem; color: var(--muted); display: inline-flex; align-items: center; gap: 0.35rem; }
    .live-status::before { content: ''; width: 8px; height: 8px; border-radius: 999px; background: rgba(255,255,255,0.3); }
    .live-status.live::before { background: #39ffb6; box-shadow: 0 0 8px rgba(57,255,182,0.6); }
    .live-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap: 0.8rem; }
    .live-card { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 1rem; background: rgba(0,0,0,0.18); display: flex; flex-direction: column; gap: 0.5rem; }
    .live-card h4 { margin: 0; font-size: 1rem; }
    .live-card h4 a { color: var(--fg); text-decoration: none; }
    .live-card h4 a:hover { color: var(--accent-gold); }
    .live-card p { margin: 0; color: var(--muted); font-size: 0.9rem; }
    .live-meta { font-size: 0.75rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); display: flex; gap: 0.5rem; align-items: center; }
    @media (max-width: 640px) { .ask-row button { width: 100%; } }
  </style>
</head>
<body>
  <header class="hero-panel hero-panel--split">
    <div class="hero-copy">
      <p class="tag" style="color: var(--accent-gold);">‚ôû goodKnight / LSU Ops Console</p>
      <h1>MikeTheTiger.AI</h1>
      <p class="lead">Live LSU intelligence for students, fans, and operators. The front-end ships with transparent data lineage, zero private APIs, and an embeddable widget you can drop onto any static site.</p>
      <div class="cta-row">
        <a class="cta-primary" href="/lsu-widget/" target="_blank" rel="noopener">Launch live widget</a>
        <a class="cta-ghost" href="https://github.com/goodkn-ght/goodkn-ght.github.io/tree/main/lsu-widget" target="_blank" rel="noopener">View bundle on GitHub</a>
      </div>
      <ul class="hero-list">
        <li>‚ö° Live LSU tabs (Athletics ¬∑ Campus ¬∑ Academic)</li>
        <li>üõ†Ô∏è GitHub Action ingests public feeds every 30 minutes</li>
        <li>üó∫Ô∏è LSU campus concierge with instant search + live web pulse</li>
      </ul>
    </div>
    <div class="hero-card">
      <h3>Embed snippet</h3>
      <pre><code>&lt;link rel="stylesheet" href="https://goodkn-ght.github.io/lsu-widget/widget.css" /&gt;
&lt;div id="lsu-widget" data-theme="dark"&gt;&lt;/div&gt;
&lt;script src="https://goodkn-ght.github.io/lsu-widget/widget.js" defer&gt;&lt;/script&gt;</code></pre>
      <p class="hero-meta">SHIP NOTE ¬∑ Works on GitHub Pages, Vercel static, Netlify, or any vanilla HTML host.</p>
    </div>
  </header>

  <section class="stat-deck">
    <article class="stat-card">
      <span>Data freshness</span>
      <strong id="meta-updated">--</strong>
      <p id="meta-source">Source: --</p>
    </article>
    <article class="stat-card">
      <span>Latency</span>
      <strong><span id="meta-latency">--</span> ms</strong>
      <p>Client-side fact pack load</p>
    </article>
    <article class="stat-card">
      <span>Live Widget</span>
      <strong>Auto-refresh</strong>
      <p>Every 45 seconds ¬∑ 3 highlight lanes</p>
    </article>
  </section>

  <main class="container">
    <section class="panel meta-grid" id="meta-grid">
      <div class="meta-card">
        <strong>Campus</strong>
        <div>1,000-acre live-oak campus on the Mississippi River ¬∑ est. 1853</div>
      </div>
      <div class="meta-card">
        <strong>People</strong>
        <div>37k+ students ¬∑ 5k faculty ¬∑ alumni in all 64 parishes & 100+ countries</div>
      </div>
      <div class="meta-card">
        <strong>Tech Stack</strong>
        <div>CCT GPU supernodes ¬∑ Stephenson E. I. S. ¬∑ AI & Data Analytics minor</div>
      </div>
      <div class="meta-card">
        <strong>Why MikeTheTiger.AI?</strong>
        <div>Instant answers with transparent references ‚Äî no opaque LLM hallucinations.</div>
      </div>
    </section>

    <section class="panel search-panel">
      <div class="ask-row">
        <input id="question" type="text" placeholder="Try: Who was LSU's first quarterback? | Where is Patrick Taylor Hall? | How big is LSU?">
        <button id="ask-btn">Ask Mike</button>
      </div>
      <div class="chip-row" id="chip-row">
        <button class="chip" data-question="How many students attend LSU?">Enrollment</button>
        <button class="chip" data-question="Tell me about LSU's AI programs.">AI Programs</button>
        <button class="chip" data-question="Who was LSU's first quarterback?">First QB</button>
        <button class="chip" data-question="Where is Patrick Taylor Hall?">Engineering Hall</button>
        <button class="chip" data-question="Any LSU events this spring?">Events</button>
        <button class="chip" data-question="What is Mike the Tiger's habitat like?">Mike's Habitat</button>
      </div>
      <div class="search-status">
        <span class="status-pill" id="fact-status">Fact pack idle</span>
        <span class="status-pill" id="web-status">DuckDuckGo idle</span>
      </div>
    </section>

    <section class="panel results-panel">
      <div class="results-grid">
        <div class="result-card" id="fact-card">
          <div class="status-pill" id="response-status">Waiting for a question‚Ä¶</div>
          <h3>Curated LSU Fact Pack</h3>
          <div class="fact-answer" id="answer-text"></div>
          <div class="reference-grid" id="reference-grid"></div>
          <div class="source-line" id="source-line"></div>
        </div>
        <div class="result-card" id="web-card">
          <div class="status-pill" id="live-status">Live web idle</div>
          <h3>DuckDuckGo Live Scan</h3>
          <p style="margin:0;color:var(--muted);">Returns fresh LSU mentions directly from DuckDuckGo the moment you ask.</p>
          <div class="web-results" id="live-results"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h3>Quick Facts</h3>
      <div class="facts-grid" id="facts-grid"></div>
    </section>

    <section class="panel events-panel">
      <h3>Upcoming LSU Moments</h3>
      <div id="events-list"></div>
    </section>

    <section class="panel live-panel">
      <div class="live-header">
        <div>
          <h3>Live Web Pulse</h3>
          <p>Direct lookups against public web endpoints whenever you ask a new question.</p>
        </div>
        <span class="tag-pill" id="live-source-pill">Source: ‚Äî</span>
      </div>
      <div class="live-status" id="live-status">Waiting for a question‚Ä¶</div>
      <div class="live-card-grid" id="live-results"></div>
    </section>
  </main>

  <footer style="text-align:center; padding:2rem; color:var(--muted); font-size:0.8rem;">
    <p>Dataset: <code>data/lsu_facts.json</code> ¬∑ Generated by goodKnight ‚ôû</p>
    <p><a href="../" style="color: var(--accent-gold);">‚Üê Back to Signal Lab</a></p>
  </footer>

  <script>
    let knowledgeBase = [];
    let lsuData = null;
    const questionInput = document.getElementById('question');
    const askBtn = document.getElementById('ask-btn');
    const answerBox = document.getElementById('answer-text');
    const statusEl = document.getElementById('response-status');
    const refsEl = document.getElementById('reference-grid');
    const sourceLine = document.getElementById('source-line');
    const liveStatusEl = document.getElementById('live-status');
    const liveResultsEl = document.getElementById('live-results');
    const factStatusPill = document.getElementById('fact-status');
    const webStatusPill = document.getElementById('web-status');
    const BRAVE_PROXY_URL = window.MIKETIGER_BRAVE_PROXY || '';
    const LIVE_PROVIDER_NAME = BRAVE_PROXY_URL ? 'Brave API Proxy' : 'DuckDuckGo Instant Answer API';
    webStatusPill.textContent = LIVE_PROVIDER_NAME + ' ready';
    let liveAbortController = null;

    async function init() {
      const t0 = performance.now();
      const resp = await fetch('../data/lsu_facts.json?t=' + Date.now());
      lsuData = await resp.json();
      const latency = Math.round(performance.now() - t0);
      document.getElementById('meta-latency').textContent = latency;
      const updatedStamp = new Date(lsuData.updated_at).toLocaleString('en-US', { hour12: false });
      document.getElementById('meta-updated').textContent = 'Updated ' + updatedStamp;
      document.getElementById('meta-source').textContent = 'Source: ' + lsuData.source;
      hydrateKnowledge(lsuData);
      renderFacts(lsuData.stats);
      renderEvents(lsuData.events);
      sourceLine.textContent = 'Sources: ' + lsuData.source;
      factStatusPill.textContent = 'Fact pack synced ' + updatedStamp;
    }

    function hydrateKnowledge(data) {
      knowledgeBase = [];
      const pushEntry = (title, body, tags = [], links = []) => {
        const tokens = (title + ' ' + body).toLowerCase().match(/[a-z0-9']+/g) || [];
        knowledgeBase.push({ title, body, tags, links, tokens });
      };
      ['highlights', 'faqs', 'people', 'places', 'traditions', 'events'].forEach(section => {
        (data[section] || []).forEach(item => {
          const title = item.title || item.question || 'Entry';
          const body = item.body || item.answer || item.details || '';
          pushEntry(title, body, item.tags || [], item.links || []);
        });
      });
    }

    function scoreEntry(entry, questionTokens) {
      let score = 0;
      const joined = questionTokens.join(' ');
      entry.tags.forEach(tag => { if (joined.includes(tag)) score += 4; });
      questionTokens.forEach(token => { if (entry.tokens.includes(token)) score += 1; });
      return score;
    }

    function structuredStats(question) {
      if (!lsuData || !lsuData.stats) return [];
      const stats = lsuData.stats;
      const lowerQ = question.toLowerCase();
      const snippets = [];
      if (/(student|enrollment|population)/.test(lowerQ)) {
        snippets.push(`LSU enrolls roughly ${stats.students.toLocaleString()} students and employs ${stats.faculty.toLocaleString()} faculty.`);
      }
      if (/(research|r1|funding|grant|spend)/.test(lowerQ)) {
        snippets.push(`Research spending cleared $${(stats.research_spend/1e6).toFixed(0)}M last year, keeping LSU in the R1 tier.`);
      }
      if (/(mascot|tiger|mike)/.test(lowerQ)) {
        snippets.push(`Mascot: ${stats.mascot}. Colors: ${stats.colors}. Mike's habitat sits between Tiger Stadium and the PMAC.`);
      }
      if (/(history|founded|establish)/.test(lowerQ)) {
        snippets.push(`Founded in ${stats.founded} as Louisiana's flagship land-grant institution.`);
      }
      if (/(first.*quarterback)/.test(lowerQ) && stats.first_quarterback) {
        snippets.push(`LSU's first documented starting quarterback was ${stats.first_quarterback}, per the LSU Athletics media guide.`);
      }
      if (/(patrick.*taylor|pft|engineering hall)/.test(lowerQ) && stats.patrick_taylor_location) {
        snippets.push(`Patrick F. Taylor Hall anchors the College of Engineering on South Stadium Drive at Nicholson Extension.`);
      }
      return snippets;
    }

    function runSearch(q) {
      if (!q.trim()) return;
      statusEl.textContent = 'Searching curated fact pack‚Ä¶';
      statusEl.classList.add('live');
      factStatusPill.textContent = 'Fact pack searching‚Ä¶';
      factStatusPill.classList.add('live');
      answerBox.innerHTML = '';
      refsEl.innerHTML = '';
      fetchLiveSearch(q);

      const tokens = q.toLowerCase().match(/[a-z0-9']+/g) || [];
      const scored = knowledgeBase.map(entry => ({ entry, score: scoreEntry(entry, tokens) }))
        .filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 4);

      const responseParts = structuredStats(q);
      if (scored.length) {
        scored.forEach((item, idx) => {
          const prefix = idx === 0 ? 'Primary match:' : 'Also note:';
          responseParts.push(`${prefix} ${item.entry.body}`);
        });
      }
      if (!responseParts.length) {
        responseParts.push("No direct match yet ‚Äî ask about enrollment, buildings, athletics, AI programs, or events.");
      }

      const answerHTML = responseParts.map(line => `<p>${line}</p>`).join('');
      simulateTyping(answerHTML, () => {
        const stamp = new Date().toLocaleTimeString('en-US', { hour12: false });
        statusEl.textContent = 'Answer generated from LSU public fact pack.';
        statusEl.classList.remove('live');
        factStatusPill.textContent = 'Fact pack updated ' + stamp;
        factStatusPill.classList.remove('live');
      });

      refsEl.innerHTML = scored.map(item => `
        <div class="reference-card">
          <h4>${item.entry.title}</h4>
          <p>${item.entry.body}</p>
          <div style="margin-top:0.35rem; display:flex; flex-wrap:wrap; gap:0.3rem;">
            ${(item.entry.tags || []).map(tag => `<span class="tag-pill">${tag}</span>`).join('')}
          </div>
          ${item.entry.links && item.entry.links.length ? `<div style="margin-top:0.45rem;"><a href="${item.entry.links[0]}" target="_blank" rel="noopener" style="color: var(--accent-gold); font-size:0.8rem;">Source ‚Üó</a></div>` : ''}
        </div>
      `).join('');
    }

    function simulateTyping(html, callback) {
      answerBox.innerHTML = '';
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const nodes = Array.from(tempDiv.childNodes);
      let idx = 0;
      function renderNext() {
        if (idx >= nodes.length) { if (callback) callback(); return; }
        answerBox.appendChild(nodes[idx]);
        idx += 1;
        setTimeout(renderNext, 110);
      }
      renderNext();
    }

    function renderFacts(stats = {}) {
      const facts = [
        { label: 'Founded', value: stats.founded },
        { label: 'Students', value: stats.students ? stats.students.toLocaleString() : '--' },
        { label: 'Faculty', value: stats.faculty ? stats.faculty.toLocaleString() : '--' },
        { label: 'Research Spend', value: stats.research_spend ? '$' + (stats.research_spend/1e6).toFixed(0) + 'M' : '--' },
        { label: 'Campus Acres', value: stats.campus_acres },
        { label: 'Mascot', value: stats.mascot },
        { label: 'Colors', value: stats.colors },
        { label: 'AI Ranking', value: stats.ranking_ai }
      ];
      document.getElementById('facts-grid').innerHTML = facts.map(f => `
        <div class="fact-card">
          <span>${f.label}</span>
          <strong>${f.value || '--'}</strong>
        </div>
      `).join('');
    }

    function renderEvents(events = []) {
      if (!events.length) {
        document.getElementById('events-list').innerHTML = '<p style="color:var(--muted)">No events recorded.</p>';
        return;
      }
      document.getElementById('events-list').innerHTML = events.map(evt => `
        <div class="event-row">
          <div class="event-date">${new Date(evt.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
          <div>
            <strong>${evt.title}</strong>
            <p>${evt.details}</p>
          </div>
        </div>
      `).join('');
    }

    function hostnameFromUrl(url = '') {
      try {
        const host = new URL(url);
        return (host.hostname || 'web').replace(/^www\./, '');
      } catch (err) {
        return 'web';
      }
    }

    function normalizeDuckDuckGo(payload = {}, query = '') {
      const results = [];
      const seen = new Set();
      const fallback = `https://duckduckgo.com/?q=${encodeURIComponent(query + ' LSU')}`;
      const push = (item) => {
        if (!item.url || seen.has(item.url)) return;
        seen.add(item.url);
        results.push(item);
      };
      if (payload.AbstractText) {
        push({
          title: payload.Heading || 'Summary',
          snippet: payload.AbstractText,
          url: payload.AbstractURL || fallback,
          source: hostnameFromUrl(payload.AbstractURL || fallback),
          tag: payload.AbstractSource || 'Summary'
        });
      }
      (payload.Results || []).forEach(result => {
        if (!result) return;
        push({
          title: result.Text || 'Result',
          snippet: result.Text || '',
          url: result.FirstURL || fallback,
          source: hostnameFromUrl(result.FirstURL || fallback),
          tag: 'Result'
        });
      });
      const flattenTopics = (topics = []) => {
        topics.forEach(topic => {
          if (!topic) return;
          if (topic.Topics) {
            flattenTopics(topic.Topics);
          } else if (topic.FirstURL && topic.Text) {
            push({
              title: topic.Text.split(' - ')[0],
              snippet: topic.Text,
              url: topic.FirstURL,
              source: hostnameFromUrl(topic.FirstURL),
              tag: 'Related'
            });
          }
        });
      };
      flattenTopics(payload.RelatedTopics || []);
      return results.slice(0, 5);
    }

    function normalizeBrave(payload = {}) {
      const results = [];
      const seen = new Set();
      const pushItems = (items = [], tag = 'Web') => {
        items.forEach(item => {
          if (!item) return;
          const url = item.url || item.link;
          if (!url || seen.has(url)) return;
          seen.add(url);
          results.push({
            title: item.title || 'Result',
            snippet: item.description || item.snippet || '',
            url,
            source: hostnameFromUrl(url),
            tag
          });
        });
      };
      pushItems(payload.web?.results, 'Web');
      pushItems(payload.news?.results, 'News');
      pushItems(payload.videos?.results, 'Video');
      return results.slice(0, 5);
    }

    function renderLiveResults(items = []) {
      if (!items.length) {
        liveResultsEl.innerHTML = '<p style="color:var(--muted)">No live references matched that query yet.</p>';
        return;
      }
      liveResultsEl.innerHTML = items.map(item => `
        <article class="web-result">
          <div class="web-meta">
            <span>${item.source}</span>
            ${item.tag ? `<span>${item.tag}</span>` : ''}
          </div>
          <h4><a href="${item.url}" target="_blank" rel="noopener">${item.title}</a></h4>
          <p>${item.snippet || 'No preview available.'}</p>
        </article>
      `).join('');
    }

    async function fetchLiveSearch(question = '') {
      if (!question.trim()) return;
      if (liveAbortController) {
        liveAbortController.abort();
      }
      liveAbortController = new AbortController();
      const signal = liveAbortController.signal;
      liveStatusEl.textContent = 'Querying ' + LIVE_PROVIDER_NAME + '‚Ä¶';
      liveStatusEl.classList.add('live');
      webStatusPill.textContent = 'Searching ' + LIVE_PROVIDER_NAME + '‚Ä¶';
      webStatusPill.classList.add('live');
      liveResultsEl.innerHTML = '';
      try {
        let liveItems = [];
        if (BRAVE_PROXY_URL) {
          const resp = await fetch(`${BRAVE_PROXY_URL}?q=${encodeURIComponent(question)}`, { signal });
          if (!resp.ok) throw new Error('Proxy returned ' + resp.status);
          const data = await resp.json();
          liveItems = normalizeBrave(data);
        } else {
          const resp = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(question + ' LSU')}&format=json&no_html=1&no_redirect=1&t=mikethetiger`, { signal });
          if (!resp.ok) throw new Error('DuckDuckGo request failed');
          const data = await resp.json();
          liveItems = normalizeDuckDuckGo(data, question);
        }
        renderLiveResults(liveItems);
        const stamp = new Date().toLocaleTimeString('en-US', { hour12: false });
        liveStatusEl.textContent = liveItems.length ? 'Live web updated ' + stamp : 'No web matches yet (' + stamp + ')';
        if (!liveItems.length) {
          liveStatusEl.classList.remove('live');
          webStatusPill.classList.remove('live');
          webStatusPill.textContent = 'No DuckDuckGo hits yet';
        } else {
          webStatusPill.textContent = 'Updated ' + stamp;
        }
      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error(err);
        liveStatusEl.classList.remove('live');
        webStatusPill.classList.remove('live');
        liveStatusEl.textContent = 'Live lookup failed: ' + err.message;
        webStatusPill.textContent = LIVE_PROVIDER_NAME + ' error';
        liveResultsEl.innerHTML = '';
      }
    }

    askBtn.addEventListener('click', () => runSearch(questionInput.value));
    questionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        runSearch(questionInput.value);
      }
    });
    document.getElementById('chip-row').addEventListener('click', (e) => {
      if (e.target.matches('[data-question]')) {
        const q = e.target.getAttribute('data-question');
        questionInput.value = q;
        runSearch(q);
      }
    });

    init();
  </script>
</body>
</html>
