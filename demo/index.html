<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Query Demo | goodKnight</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    :root { --accent-db: #ff6b6b; }
    .demo-container { max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; }
    .query-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .query-editor { font-family: 'Space Mono', monospace; background: #0a0c14; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; color: #ff6b6b; font-size: 0.9rem; min-height: 80px; white-space: pre; overflow-x: auto; }
    .results-grid { display: grid; gap: 1rem; }
    .result-card { background: var(--panel); border-left: 3px solid var(--accent-db); padding: 1rem; border-radius: 0 8px 8px 0; }
    .stats-bar { display: flex; gap: 2rem; padding: 0.75rem 1rem; background: rgba(255,107,107,0.1); border-radius: 6px; margin-top: 1rem; font-size: 0.85rem; flex-wrap: wrap; }
    .live-indicator { display: inline-flex; align-items: center; gap: 0.5rem; }
    .live-indicator::before { content: ''; width: 8px; height: 8px; background: #00d4aa; border-radius: 50%; animation: pulse 1s infinite; }
    .live-indicator.error::before { background: #ff6b6b; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
    .schema-docs { margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.85rem; }
    .schema-docs code { color: #ffd93d; }

    /* ETL Pipeline Tracker */
    .pipeline { display: flex; align-items: center; gap: 0; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .pipeline-stage { flex: 1; min-width: 180px; background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; text-align: center; position: relative; transition: border-color 0.3s, box-shadow 0.3s; }
    .pipeline-stage.active { border-color: #00d4aa; box-shadow: 0 0 12px rgba(0,212,170,0.2); }
    .pipeline-stage.done { border-color: #00d4aa; }
    .pipeline-stage.error { border-color: #ff6b6b; }
    .pipeline-stage h4 { margin: 0 0 0.25rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
    .pipeline-stage .stage-icon { font-size: 1.4rem; margin-bottom: 0.25rem; }
    .pipeline-stage .stage-value { font-size: 1.1rem; font-weight: 700; color: var(--fg); }
    .pipeline-stage .stage-detail { font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem; }
    .pipeline-arrow { font-size: 1.2rem; color: var(--muted); padding: 0 0.5rem; flex-shrink: 0; }

    /* Aggregation Cards */
    .agg-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
    .agg-card { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; }
    .agg-card h4 { margin: 0 0 0.75rem; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
    .agg-bar-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem; }
    .agg-bar-label { min-width: 100px; color: var(--fg); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .agg-bar-track { flex: 1; height: 18px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
    .agg-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
    .agg-bar-count { min-width: 30px; text-align: right; color: var(--muted); font-size: 0.8rem; }

    /* Sortable table */
    .results-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .results-table th { text-align: left; padding: 0.6rem 0.75rem; border-bottom: 2px solid var(--border); color: var(--muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.04em; cursor: pointer; user-select: none; white-space: nowrap; }
    .results-table th:hover { color: var(--fg); }
    .results-table th .sort-arrow { margin-left: 0.25rem; font-size: 0.7rem; }
    .results-table td { padding: 0.6rem 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--fg); }
    .results-table tr { transition: background 0.15s; }
    .results-table tr:hover { background: rgba(255,255,255,0.03); }
    .results-table .num { text-align: right; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <header class="hero" style="padding: 2rem 1.5rem;">
    <div class="hero__inner" style="grid-template-columns: 1fr;">
      <div>
        <p class="tag" style="color: #ff6b6b;">‚ôû goodKnight / Demo</p>
        <h1>Live Database Query Interface</h1>
        <p class="lead">Real-time ETL pipeline: Moltbook API ‚Üí filtering ‚Üí aggregation ‚Üí visualization</p>
        <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
          <span class="live-indicator" id="live-status" style="color: var(--muted);">Connecting to data source‚Ä¶</span>
          <span style="color: var(--muted);">Latency: <span id="latency">--</span>ms</span>
          <span style="color: var(--muted);">Updated: <span id="updated-at">--</span></span>
          <span style="color: var(--muted);" id="refresh-label">Auto-refresh idle</span>
        </div>
      </div>
    </div>
  </header>

  <main class="demo-container">

    <!-- ETL Pipeline Stages -->
    <div class="pipeline" id="pipeline">
      <div class="pipeline-stage" id="stage-extract">
        <div class="stage-icon">üì°</div>
        <h4>Extract</h4>
        <div class="stage-value" id="extract-val">--</div>
        <div class="stage-detail">records from API</div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-stage" id="stage-transform">
        <div class="stage-icon">‚öôÔ∏è</div>
        <h4>Transform</h4>
        <div class="stage-value" id="transform-val">--</div>
        <div class="stage-detail" id="transform-detail">filtered &amp; sorted</div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-stage" id="stage-load">
        <div class="stage-icon">üìä</div>
        <h4>Load</h4>
        <div class="stage-value" id="load-val">--</div>
        <div class="stage-detail">rows displayed</div>
      </div>
    </div>

    <!-- Query Panel -->
    <div class="query-panel">
      <h3>Query Source</h3>
      <div class="query-editor" id="query-display">SELECT agent_name, title, comment_count, upvotes, created_at
FROM moltbook_posts
WHERE content_length > 80
  AND NOT spam_filter(title, content)
ORDER BY comment_count DESC
LIMIT 10;</div>
      <div class="stats-bar">
        <span><strong>Records fetched:</strong> <span id="record-count">--</span></span>
        <span><strong>After filter:</strong> <span id="filtered-count">--</span></span>
        <span><strong>Total engagement:</strong> <span id="total-engagement">--</span></span>
        <span><strong>Avg comments:</strong> <span id="avg-comments">--</span></span>
      </div>
    </div>

    <!-- Results Table (sortable) -->
    <div class="query-panel">
      <h3>Results</h3>
      <div style="overflow-x: auto;">
        <table class="results-table" id="results-table">
          <thead>
            <tr>
              <th data-col="agent_name">Agent <span class="sort-arrow"></span></th>
              <th data-col="title">Title <span class="sort-arrow"></span></th>
              <th data-col="comment_count" class="num">Comments <span class="sort-arrow">‚ñº</span></th>
              <th data-col="upvotes" class="num">Upvotes <span class="sort-arrow"></span></th>
              <th data-col="created_at">Date <span class="sort-arrow"></span></th>
            </tr>
          </thead>
          <tbody id="results-body">
            <tr><td colspan="5" style="text-align:center; color:var(--muted);">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Aggregations -->
    <div class="agg-grid" id="agg-grid">
      <div class="agg-card">
        <h4>GROUP BY author</h4>
        <div id="agg-authors">Loading‚Ä¶</div>
      </div>
      <div class="agg-card">
        <h4>GROUP BY category</h4>
        <div id="agg-categories">Loading‚Ä¶</div>
      </div>
    </div>

    <!-- Schema Docs -->
    <div class="schema-docs">
      <strong>Schema Reference:</strong><br>
      <code>posts.id</code> UUID PRIMARY KEY |
      <code>posts.author.agent_name</code> VARCHAR(32) |
      <code>posts.title</code> TEXT INDEXED |
      <code>posts.comment_count</code> INTEGER |
      <code>posts.upvotes</code> INTEGER |
      <code>posts.created_at</code> TIMESTAMP |
      <code>posts.category</code> VARCHAR(32)
    </div>
  </main>

  <footer style="text-align: center; padding: 2rem; color: var(--muted); font-size: 0.8rem;">
    <p>Data refreshed by <code>scripts/update_engagement.py</code> ¬∑ Source: Moltbook API ¬∑ goodKnight ‚ôû</p>
    <p><a href="../" style="color: var(--accent-db);">‚Üê Back to Signal Lab</a></p>
  </footer>

  <script>
    let liveData = null;
    let sortCol = 'comment_count';
    let sortAsc = false;
    let lastRenderSignature = '';
    let stageTimers = [];
    const REFRESH_INTERVAL_MS = 45000;
    let refreshTimeoutId = null;
    let countdownIntervalId = null;
    let nextRefreshAt = null;
    const refreshLabel = document.getElementById('refresh-label');
    const dateFormatter = new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    function updateRefreshLabel() {
      if (!nextRefreshAt) {
        refreshLabel.textContent = 'Auto-refresh idle';
        return;
      }
      const remaining = nextRefreshAt - Date.now();
      if (remaining <= 0) {
        refreshLabel.textContent = 'Refreshing now‚Ä¶';
      } else {
        refreshLabel.textContent = `Auto-refresh in ${Math.ceil(remaining / 1000)}s`;
      }
    }

    function scheduleRefresh() {
      if (refreshTimeoutId) clearTimeout(refreshTimeoutId);
      if (countdownIntervalId) clearInterval(countdownIntervalId);
      nextRefreshAt = Date.now() + REFRESH_INTERVAL_MS;
      updateRefreshLabel();
      countdownIntervalId = setInterval(updateRefreshLabel, 1000);
      refreshTimeoutId = setTimeout(() => {
        fetchData(true);
      }, REFRESH_INTERVAL_MS);
    }

    async function fetchData(autoTriggered = false) {
      const t0 = performance.now();
      try {
        const resp = await fetch('../data/hot-topics.json?t=' + Date.now());
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        liveData = await resp.json();
        const latency = Math.round(performance.now() - t0);
        document.getElementById('latency').textContent = latency;
        document.getElementById('live-status').textContent = 'Live ‚Äî hot-topics.json';
        document.getElementById('live-status').className = 'live-indicator';
        render(true);
      } catch (e) {
        document.getElementById('live-status').textContent = 'Error: ' + e.message;
        document.getElementById('live-status').className = 'live-indicator error';
      } finally {
        scheduleRefresh();
      }
    }

    function resetStageAnimations() {
      stageTimers.forEach(clearTimeout);
      stageTimers = [];
      document.querySelectorAll('.pipeline-stage').forEach(stage => {
        stage.classList.remove('active', 'done', 'error');
      });
    }

    function animateStage(id, delay) {
      const startTimer = setTimeout(() => {
        const el = document.getElementById(id);
        el.classList.add('active');
        const doneTimer = setTimeout(() => {
          el.classList.remove('active');
          el.classList.add('done');
        }, 400);
        stageTimers.push(doneTimer);
      }, delay);
      stageTimers.push(startTimer);
    }

    function render(force = false) {
      if (!liveData) return;
      const p = liveData.pipeline;
      const agg = liveData.aggregations;
      const results = liveData.results || [];
      const signaturePayload = {
        updated_at: liveData.updated_at,
        pipeline: p,
        metrics: agg ? agg.metrics : null,
        authors: agg ? agg.by_author : null,
        categories: agg ? agg.by_category : null,
        results
      };
      const signature = JSON.stringify(signaturePayload);
      if (!force && signature === lastRenderSignature) {
        return;
      }
      lastRenderSignature = signature;

      // Updated timestamp
      if (liveData.updated_at) {
        const d = new Date(liveData.updated_at);
        document.getElementById('updated-at').textContent = d.toLocaleString();
      }

      // Pipeline stages
      document.getElementById('extract-val').textContent = p.extract.records_fetched;
      document.getElementById('transform-val').textContent = p.transform.filtered_count;
      document.getElementById('transform-detail').textContent = p.transform.filter_rule;
      document.getElementById('load-val').textContent = p.load.displayed;

      resetStageAnimations();
      animateStage('stage-extract', 200);
      animateStage('stage-transform', 600);
      animateStage('stage-load', 1000);

      // Stats bar
      document.getElementById('record-count').textContent = p.extract.records_fetched;
      document.getElementById('filtered-count').textContent = p.transform.filtered_count;
      document.getElementById('total-engagement').textContent = (agg.metrics.total_engagement || 0).toLocaleString();
      document.getElementById('avg-comments').textContent = (agg.metrics.avg_comments || 0).toFixed(1);

      // Render table
      renderTable(results);

      // Aggregations
      renderAggBars('agg-authors', agg.by_author, 'agent', 'post_count', '#8ea5ff');
      renderAggBars('agg-categories', agg.by_category, 'category', 'count', '#00d4aa');
    }

    function renderTable(results) {
      const sorted = [...results].sort((a, b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });

      const tbody = document.getElementById('results-body');
      const fragment = document.createDocumentFragment();
      sorted.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.style.animation = `fadeIn 0.3s ${i * 0.04}s both`;
        tr.innerHTML = `
          <td>${esc(r.agent_name || '?')}</td>
          <td>${esc(r.title)}</td>
          <td class="num">${(r.comment_count || 0).toLocaleString()}</td>
          <td class="num">${(r.upvotes || 0).toLocaleString()}</td>
          <td>${r.created_at ? dateFormatter.format(new Date(r.created_at)) : '--'}</td>
        `;
        fragment.appendChild(tr);
      });
      tbody.innerHTML = '';
      tbody.appendChild(fragment);

      // Update sort arrows
      document.querySelectorAll('.results-table th').forEach(th => {
        const arrow = th.querySelector('.sort-arrow');
        if (th.dataset.col === sortCol) {
          arrow.textContent = sortAsc ? '‚ñ≤' : '‚ñº';
        } else {
          arrow.textContent = '';
        }
      });
    }

    function renderAggBars(containerId, data, labelKey, valueKey, color) {
      const container = document.getElementById(containerId);
      if (!data || data.length === 0) {
        container.innerHTML = '<span style="color:var(--muted)">No data</span>';
        return;
      }
      const max = Math.max(...data.map(d => d[valueKey]));
      container.innerHTML = data.map(d => {
        const pct = max > 0 ? (d[valueKey] / max * 100) : 0;
        return `
          <div class="agg-bar-row">
            <span class="agg-bar-label">${esc(d[labelKey] || '?')}</span>
            <div class="agg-bar-track">
              <div class="agg-bar-fill" style="width:${pct}%;background:${color};"></div>
            </div>
            <span class="agg-bar-count">${d[valueKey]}</span>
          </div>`;
      }).join('');
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Sortable columns
    document.querySelectorAll('.results-table th[data-col]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (sortCol === col) {
          sortAsc = !sortAsc;
        } else {
          sortCol = col;
          sortAsc = col === 'title' || col === 'agent_name'; // alpha cols default asc
        }
        if (liveData) renderTable(liveData.results || []);
      });
    });

    // Init
    fetchData();
  </script>
</body>
</html>
